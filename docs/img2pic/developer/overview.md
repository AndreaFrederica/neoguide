# 项目概述

本文介绍 img2pic 项目的整体设计理念和架构。

## 项目目标

img2pic 旨在解决 AI 生成的"像素风格"图像的问题：

1. **伪像素检测**：识别图像中的像素网格结构
2. **网格重建**：从不规则的像素重建规则网格
3. **像素艺术生成**：生成真正的像素艺术输出
4. **工具集成**：提供多种算法满足不同需求

## 设计理念

### 1. 多工具策略

不同的图像特征需要不同的处理方法：

- **简单规则网格**：使用简单的边缘检测
- **复杂不规则网格**：使用能量图算法
- **需要颜色优化**：使用颜色合并功能

### 2. 参数可调

所有关键参数都可以调整：

```python
# 边缘检测阈值
--edge-threshold 0.1

# 网格尺寸范围
--min-grid-size 4
--max-grid-size 16

# 颜色控制
--colors 32
--color-threshold 0.1
```

### 3. 调试友好

所有工具都提供调试输出：

```python
# 保存能量图
--save-energy

# 保存网格可视化
--debug
```

### 4. 模块化设计

每个工具都是独立的，可以单独使用：

```
energ                    # 独立工具
edge_detect_pixelize.py  # 独立工具
grid_sampling_pixelize.py # 独立工具
demo_pixelize.py         # 独立工具
```

## 架构设计

### 分层架构

```
┌─────────────────────────────────────┐
│   命令行接口 (CLI)                   │
├─────────────────────────────────────┤
│   参数解析 (argparse)               │
├─────────────────────────────────────┤
│   图像处理核心                      │
│   ├─ 能量图算法                     │
│   ├─ 边缘检测算法                   │
│   └─ 网格采样算法                   │
├─────────────────────────────────────┤
│   图像 I/O (Pillow)                 │
├─────────────────────────────────────┤
│   数值计算 (NumPy)                  │
│   图像处理 (OpenCV)                 │
│   信号处理 (SciPy)                  │
└─────────────────────────────────────┘
```

### 工具架构

每个工具都遵循相似的结构：

```python
def main():
    # 1. 参数解析
    args = _parse_args()

    # 2. 输入验证
    input_path = Path(args.input_path)
    if not input_path.exists():
        raise SystemExit(f"Input not found: {input_path}")

    # 3. 图像加载
    image = Image.open(input_path).convert("RGB")

    # 4. 图像处理
    result = process_image(image, args)

    # 5. 输出保存
    result.save(output_path)
```

## 数据流

### 输入 → 输出

```
输入图像 (PNG/JPG/...)
    ↓
[加载] PIL Image
    ↓
[转换] NumPy Array (RGB)
    ↓
[检测] 网格线位置
    ↓
[采样] 像素颜色值
    ↓
[量化] 颜色调色板
    ↓
[放大] 最近邻插值
    ↓
输出图像 (PNG)
```

### 数据结构

```python
# 图像表示
image: np.ndarray  # shape: (H, W, 3), dtype: uint8

# 网格线
h_lines: list[int]  # 水平网格线的 Y 坐标
v_lines: list[int]  # 垂直网格线的 X 坐标

# 像素化图像
pixelated: np.ndarray  # shape: (grid_h, grid_w, 3)
```

## 算法选择

### 能量图算法

**适用场景**：
- 复杂的 AI 生成图像
- 不规则的网格分布
- 需要局部峰值检测

**优势**：
- 高精度检测
- 自适应网格尺寸
- 网格线插值

**劣势**：
- 计算量较大
- 参数较多

### 边缘检测算法

**适用场景**：
- 简单的像素风格图像
- 规则的网格分布
- 需要快速处理

**优势**：
- 处理速度快
- 参数简单
- 易于理解

**劣势**：
- 精度较低
- 无法检测局部峰值

### 峰值检测算法

**适用场景**：
- 需要多尺度检测
- 不规则网格需要规律化
- 需要颜色合并

**优势**：
- 多尺度检测
- 峰值检测精确
- 颜色合并功能

**劣势**：
- 计算量中等
- 可能过度检测

## 性能考虑

### 时间复杂度

| 算法 | 时间复杂度 |
|------|-----------|
| 能量图算法 | O(W × H × window_size) |
| 边缘检测算法 | O(W × H) |
| 峰值检测算法 | O(W × H × num_scales) |
| 颜色量化 | O(N × log N) |

### 空间复杂度

| 算法 | 空间复杂度 |
|------|-----------|
| 能量图算法 | O(W × H) |
| 边缘检测算法 | O(W × H) |
| 峰值检测算法 | O(W × H) |
| 颜色量化 | O(N) |

### 优化策略

1. **降采样**：先缩小处理再放大结果
2. **ROI 处理**：只处理感兴趣的区域
3. **并行处理**：水平和垂直方向并行处理
4. **向量化**：使用 NumPy 向量化操作

## 扩展性

### 添加新工具

1. 创建新的 Python 脚本
2. 实现标准的命令行接口
3. 遵循现有的代码风格
4. 添加文档和测试

### 添加新算法

1. 在现有工具中添加新函数
2. 保持向后兼容
3. 添加参数控制
4. 更新文档

### 集成到其他项目

```python
# 作为模块导入
from img2pic import energ

# 作为命令调用
import subprocess
subprocess.run(['python', 'energ', '--in', 'input.png'])
```

## 依赖管理

### 核心依赖

- **numpy >= 1.20**：数值计算
- **pillow >= 9.0**：图像 I/O
- **opencv-python >= 4.0**：图像处理
- **scipy >= 1.7**：信号处理

### 开发依赖

- **pytest >= 6.0**：单元测试
- **black >= 21.0**：代码格式化
- **mypy >= 0.900**：类型检查

## 未来方向

### 短期目标

1. 改进算法性能
2. 添加更多调试功能
3. 改进文档
4. 增加测试覆盖

### 长期目标

1. 机器学习集成
2. 实时处理支持
3. 视频处理支持
4. GUI 界面

---

[← 返回开发者文档](./)
